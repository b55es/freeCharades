<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width" />
        <title>Free Charades</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Alata&family=Henny+Penny&display=swap" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="styles.css" />
    </head>
    <body id="container">
        <button id="fullscreen" class="secondary-button">⛶</button>
        <div id="permission-request-screen" class="screen overlay">
            <div id="permission-request-screen-cont">
                <div id="permission-request-screen-content">
                    <div class="logo-container">
                        <img src="logo.png" class="logo"> 
                        <h1 class="brand-name">Free Charades</h1>
                    </div>
                    <img id="flip-90" src="flip-90.png">
                    <p id="permission-request-instruction">For Free Charades to work, we need to know the orientation of your device. Please press the 'Authorize' button below, and on the dialog box that appears, press 'Allow'.
                    </p>
                    <button id="request-orientation-permission-button" class="primary-button">Authorize</button>                  
                </div>
            </div>
        </div>

        <div id="starting-screen" class="screen active">
            <div id="starting-screen-cont">
                <div id="starting-screen-content">
                    <div class="logo-container">
                        <img src="logo.png" class="logo"> 
                        <h1 class="brand-name">Free Charades</h1>
                    </div>
                    <button id="start" class="primary-button">Start</button>
                    <button id="instruction-button" class="secondary-button">How to Play?</button>
                    <button id="acknowledgements-button" class="secondary-button">Acknowledgements</button>
                </div>
            </div>
        </div>

        <div id="flip-180-screen" class="screen">
            <div id="flip-180-screen-cont">
                <div id="flip-180-screen-content">
                    <div class="logo-container">
                        <img src="logo.png" class="logo"> 
                        <h1 class="brand-name">Free Charades</h1>
                    </div>
                    <img id="flip-180" src="flip-180.png">
                    <p id="instruction-line1">Please flip your phone to 180<sup>o</sup></p>
                </div>
            </div>
        </div>

        <div id="flip-90-screen" class="screen">
            <div id="flip-90-screen-cont">
                <div id="flip-90-screen-content">
                    <div class="logo-container">
                        <img src="logo.png" class="logo"> 
                        <h1 class="brand-name">Free Charades</h1>
                    </div>
                    <img id="flip-90" src="flip-90.png">
                    <p id="instruction-line2">Please flip your phone to landscape</p>
                </div>
            </div>
        </div>

        <div id="instruction-screen" class="screen">
            <buton id= "back-instruction" class="back-button">« Back</buton>
            <h1 id="how-to-play">How to Play?</h1>
            <ol id="instructions">
                <li>Press 'Start' and then hold the phone up on your forehead, facing the audience.</li>
                <li>After the countdown, the session will start and a word or phrase will show on the screen. The audience should act out the word or phrase, without using words.</li>
                <li>You have to guess the word or phrase by saying it out loud. Tthe audience will tell you if you guessed it right or not.</li>
                <li>If you guessed it right, flip the phone up above your head, and the back down onto your forehead.</li>
                <li>To move on to the next word without gurssing correctly, flip the phone down and back up.</li>
                <li>Your score is displayed at the end of the session.</li>
            </ol>
        </div>

        <div id="acknowledgements-screen" class="screen">
            <buton id="back-acknowledgements" class="back-button">« Back</buton>
            <h1 id="acknowledgements">Acknowledgements</h1>
            <div id="designers">
                <p>Made by Phuong Khuu &copy; 2023</p>
                <p>Site designed by Daniel Li</p>
                <p>Timer icon by <a href="http://thenounproject.com/browse/icons/term/time-melts-away/" target="_blank" title="Time melts away Icons">Ian Vibbert</a></p>
                <p>Rotate phone icon by <a href="http://thenounproject.com/browse/icons/term/rotate-phone/" target="_blank" title="Rotate Phone Icons">Kelig Le Luron</a></p>
            </div>
        </div>

        <div id="countdown-screen" class="screen">
            <div id="countdown-screen-content">
                <p id="timer">Timer</p>
            </div>
        </div>

        <div id="word-screen" class="screen">
            <div id="word-screen-content">
                <div id="session-time">
                    <img src="clock.png" id="clock">
                    <p id="play-timer">64</p>
                </div>
                <p id="word">Hampster</p>
            </div>
        </div>

        <div id="ending-screen" class="screen">
            <div id="ending-screen-content">
                <div id="left">
                    <p id="here-were-the-words">Here were the words</p>
                    <div id="word-list">
                        <ul id="list-of-words">
                            <li class="correct">apple</li>
                            <li class="incorrect">orange</li>
                            <li class="correct">banana</li>
                            <li class="correct">pineapple</li>
                            <li class="correct">coconut</li>
                            <li>apple</li>
                            <li>apple</li>
                            <li>apple</li>
                            <li>apple</li>
                            <li>apple</li>
                            <li>apple</li>
                            <li>apple</li>
                            <li>apple</li>
                            <li>apple</li>
                        </ul>
                    </div>
                </div>
                <div>
                    <div id="right">
                        <div id="result-content">
                            <div id="result">
                                <h1>Time's up!</h1>
                                <p id="your-score-is">Your score is</p>
                            </div>
                            <div id="result-num">
                                <p id="score">7</p>
                                <div id="number-of-words-box">
                                    <p id="number-of-words">/12</p>
                                </div>
                            </div>
                        </div>
                    <button id="restart" class="primary-button">Restart</button>
                    <button id="back-home" class="secondary-button">Back to Home</button>
                    </div>    
                </div>
            </div>
        </div>
       
        <script>

            // Constants
            const COUNTDOWN_DURATION_SECONDS = 3;
            const SESSION_DURATION_SECONDS = 60;
            const STARTING_SCORE = 0;

            // Initial states
            const originalWordList = [
                "dog", 
                "lion", 
                "cat", 
                "monkey", 
                "elephant", 
                "tiger", 
                "crocodile", 
                "whale", 
                "tuna", 
                "salmon", 
                "sea urchin", 
                "fox", 
                "eagle", 
                "parrot",
                "snake",
                "frog",
                "butterfly",
                "rabbit",
                "wolf",
                "bear",
                "pig",
                "cow",
                "chicken",
                "zebra",
                "horse",
                "goat"
            ];
            let currentWordList = [];
            let resultWordList = [];
            let time;
            let previousScreen;

            //getting html references to js variables
            const container = document.getElementById("container");
            const requestOrientationPermissionsButton = document.getElementById("request-orientation-permission-button");
            const startButton = document.getElementById("start");
            const restartButton = document.getElementById("restart");
            const instructionButton = document.getElementById("instruction-button");
            const acknowledgementsButton = document.getElementById("acknowledgements-button");
            const backHomeButton = document.getElementById("back-home");
            const backAcknowledgements = document.getElementById("back-acknowledgements");
            const backInstruction = document.getElementById("back-instruction");

            const wordParagraph = document.getElementById("word");
            const scoreParagraph = document.getElementById("score");
            const timerParagraph = document.getElementById("timer");
            const playTimerParagraph = document.getElementById("play-timer");
            const listOfWords = document.getElementById("list-of-words");
            const numberOfWords = document.getElementById("number-of-words");
            const fullScreenButton = document.getElementById("fullscreen");

            const permissionRequestScreen = document.getElementById("permission-request-screen");
            const startingScreen = document.getElementById("starting-screen");
            const flipScreen180 = document.getElementById("flip-180-screen");
            const flipScreen90 = document.getElementById("flip-90-screen");
            const instructionScreen = document.getElementById("instruction-screen");
            const acknowledgementsScreen = document.getElementById("acknowledgements-screen");
            const countdownScreen = document.getElementById("countdown-screen");
            const wordScreen = document.getElementById("word-screen");
            const endingScreen = document.getElementById("ending-screen");
            const arrayScreen = [
                permissionRequestScreen,
                startingScreen,
                flipScreen180,
                flipScreen90,
                instructionScreen,
                acknowledgementsScreen,
                countdownScreen,
                wordScreen,
                endingScreen
            ];

            function storePreviousScreen() {
                const currentActiveScreen = arrayScreen.filter((screen) => screen.classList.contains("active"))[0];
                if (currentActiveScreen === flipScreen180 || currentActiveScreen === flipScreen90) {
                    // Do nothing
                } else {
                previousScreen = currentActiveScreen
                }
            }
            storePreviousScreen()

            function setActive(screen) {
                storePreviousScreen()
                for (let i = 0; i < arrayScreen.length; i++) {
                    // If the current screen has an ID that matches screenId
                    // Add the "active" class to the screen element
                    if (arrayScreen[i] === screen) {
                        arrayScreen[i].classList.add("active");
                    }
                    // Otherwise, remove the active class
                    else {
                        arrayScreen[i].classList.remove("active");
                    }
                } 
            }

            function setOverlay(screen) {
                screen.classList.add("overlay");
            }

            function removeOverlay(screen) {
                screen.classList.remove("overlay");
            }

            const showRandomWord = () => {
                const randomIndex = Math.floor(Math.random() * currentWordList.length);
                const newWord = currentWordList[randomIndex];
                // after we select the word, we remove it from the list
                currentWordList.splice(randomIndex, 1);
                wordParagraph.innerHTML = newWord;
            }

            function storeWord(correct) {
                resultWordList.push({
                    word: wordParagraph.innerHTML,
                    correct: correct,
                });
                console.log(resultWordList);
            }

            function showScore() {
                let score = 0;
                for (i = 0; i < resultWordList.length; i++) {
                    if (resultWordList[i].correct === true) {
                        score++
                    };
                }
                scoreParagraph.innerHTML = score;
                numberOfWords.innerHTML = "/" + resultWordList.length;
            }

            function gameStart() {
                setActive(countdownScreen);
                resultWordList = [];
                currentWordList = [...originalWordList];
                
                countDown(COUNTDOWN_DURATION_SECONDS, () => { 
                    setActive(wordScreen);
                    showRandomWord();
                
                    countDown(SESSION_DURATION_SECONDS, () => {
                        showResultList();
                        showScore()
                        setActive(endingScreen);
                    })
                });
            }

            const countDown = (duration, callback) => {
                setTime(duration);
                const intervalId = setInterval(() => {
                    if (time > 0) {
                        setTime(time - 1);
                    }
                    if (time === 0) {
                        clearInterval(intervalId);
                        callback();
                    }
                }, 1000);
            }

            const setTime = (timeToSet) => {
                time = timeToSet;
                timerParagraph.innerHTML = time;
                playTimerParagraph.innerHTML = time;
            }

            function showResultList() {
                // clear everything inside the list of words
                listOfWords.innerHTML = "";

                // for each result I add one li element back into the list of words
                resultWordList.forEach(result => {
                    const li = document.createElement("li");

                    // if it's incorrect, add an incorrect class to the element
                    if (result.correct === false) {
                        li.classList.add("incorrect");
                    }

                    const resultWord = document.createTextNode(result.word);
                    li.appendChild(resultWord);
                    listOfWords.appendChild(li);
                })
            }

            instructionButton.addEventListener('click', function(){
                setActive(instructionScreen)
            });

            acknowledgementsButton.addEventListener('click', function(){
                setActive(acknowledgementsScreen)
            });

            backAcknowledgements.addEventListener('click', function(){
                setActive(startingScreen)
            });

            backInstruction.addEventListener('click', function(){
                setActive(startingScreen)
            });

            backHomeButton.addEventListener('click', function(){
                setActive(startingScreen)
            });

            startButton.addEventListener('click', function() {
                gameStart()
            });

            restartButton.addEventListener('click', function(){
                gameStart()
            });

            function gammaToDecision(gam) {
                if (1 < gam && gam < 35) {
                    return 'correct';
                }
                else if (-40 < gam && gam < -1) {
                    return 'incorrect';
                }
                else {
                    return 'normal';
                }
            }


            let previousDecision;

            const handleOrientation = (event) => {
                const currentDecision = gammaToDecision(event.gamma);

                if (currentDecision === 'correct' && previousDecision === 'normal') {
                    storeWord(true);
                    showRandomWord();
                }
                else if (currentDecision === 'incorrect' && previousDecision === 'normal') {
                    storeWord(false);
                    showRandomWord();
                }
                previousDecision = currentDecision
            };
            
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                // iOS
                requestOrientationPermissionsButton.addEventListener('click', () => {
                    const promise = DeviceOrientationEvent.requestPermission()

                    promise.then((state) => {
                        if (state === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                            removeOverlay(permissionRequestScreen);

                        } else {
                            console.error('Request to access the orientation was rejected');
                        }
                    })
                    .catch(console.error);
                });
            } else {
                // non-iOS
                window.addEventListener('deviceorientation', handleOrientation);
                removeOverlay(permissionRequestScreen);
            }

            // write a function 
            function flipScreen() {
                // if the screen is vertical, show flipScreen90
                if (screen.orientation.type === "portrait-primary" || screen.orientation.type === "portrait-secondary") {
                    setOverlay(flipScreen90);
                    removeOverlay(flipScreen180);
                }
                // if the screen , show flipScreen180
                // Android doesn't have landscape-secondary
                else if (screen.orientation.type === "landscape-secondary") {
                    setOverlay(flipScreen180);
                    removeOverlay(flipScreen90);
                }
                // remove class overlay from the flip screens
                else {
                    removeOverlay(flipScreen90);
                    removeOverlay(flipScreen180);
                }
            }

            flipScreen();
            window.addEventListener("focus", flipScreen);
            screen.orientation.addEventListener("change", flipScreen);

            fullScreenButton.addEventListener('click', () => {
                if (!document.fullscreenElement) {
                    container.requestFullscreen()
                } else {
                    document.exitFullscreen();
                }
            })
        </script>
    </body>
</html>